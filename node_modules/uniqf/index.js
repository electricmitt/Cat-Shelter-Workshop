var fs = require('fs');
var crypto = require('crypto');
var path = require('path');
var b64 = require('urlsafe-base64');

module.exports = function (src, dest, cb) {
  if (typeof dest === 'function') {
    cb = dest;
    dest = src;
  }

  var s = fs.createReadStream(src);
  var hash = crypto.createHash('md5');
  var errors = null;

  s.on('error', function (err) {
    if (errors) return;
    cb(errors = err);
  });

  s.on('data', function (chunk) {
    if (errors) return;
    hash.update(chunk);
  });

  s.on('end', function (chunk) {
    if (errors) return;
    cb(null, fname(dest, hash.digest()));
  });
};

function fname (file, digest) {
  var dir = path.dirname(file);
  var ext = path.extname(file);
  var base = path.basename(file, ext);

  return path.join(dir, base + '.' + b64.encode(digest) + ext);
}
